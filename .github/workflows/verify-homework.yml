name: C# Homework Tests

# pull_request_target kullanarak fork'lardan gelen PR'lara da yorum yazabiliyoruz
on:
  pull_request_target:
    paths:
      - 'homeworks/csharp-fundamentals/**/submissions/**'
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    name: Validate & Test C# Submissions

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Find Changed Files
        id: changed-files
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          echo "Base SHA: $BASE_SHA"
          echo "Head SHA: $HEAD_SHA"
          
          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA -- 'homeworks/csharp-fundamentals/**/submissions/*.cs' 2>/dev/null || echo "")
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "any_changed=false" >> $GITHUB_OUTPUT
            echo "DeÄŸiÅŸen C# submission dosyasÄ± bulunamadÄ±."
          else
            echo "any_changed=true" >> $GITHUB_OUTPUT
            echo "all_changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "DeÄŸiÅŸen dosyalar:"
            echo "$CHANGED_FILES"
          fi

      - name: Validate File Names
        id: validate-files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ“‹ Dosya AdÄ± KontrolÃ¼"
          echo "===================="
          
          VALID=true
          INVALID_FILES=""
          VALID_FILES=""
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            filename=$(basename "$file")
            echo "Kontrol ediliyor: $filename"
            
            if [[ ! $filename =~ ^Problem[1-4]_[0-9]+\\.cs$ ]]; then
              echo "âŒ HATA: $filename formatÄ± yanlÄ±ÅŸ!"
              echo "   Beklenen: ProblemX_OGRENCI_NO.cs (Ã¶ÄŸrenci numarasÄ±, hane sayÄ±sÄ± sÄ±nÄ±rlamasÄ± yok)"
              INVALID_FILES="${INVALID_FILES}${filename}, "
              VALID=false
            else
              echo "âœ… Format doÄŸru: $filename"
              VALID_FILES="${VALID_FILES}${file}\n"
            fi
          done <<< "${{ steps.changed-files.outputs.all_changed_files }}"
          
          echo "valid_files<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VALID_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "$VALID" = false ]; then
            echo ""
            echo "âš ï¸ BazÄ± dosya adlarÄ± yanlÄ±ÅŸ formatta!"
            # Remove trailing comma and space
            INVALID_FILES="${INVALID_FILES%, }"
            echo "invalid_files=$INVALID_FILES" >> $GITHUB_OUTPUT
            echo "valid=false" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âœ… TÃ¼m dosya adlarÄ± doÄŸru formatta!"
            echo "valid=true" >> $GITHUB_OUTPUT
          fi


      - name: Run All Tests
        id: run-tests
        if: steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'true'
        run: |
          echo "ğŸ§ª Testler BaÅŸlÄ±yor"
          echo "==================="
          
          ALL_PASSED=true
          TOTAL_SCORE=0
          
          # Track which problems are submitted
          SUBMITTED_P1=false
          SUBMITTED_P2=false
          SUBMITTED_P3=false
          SUBMITTED_P4=false
          
          # Create comment body file
          echo "## ğŸ“Š C# Ã–dev Test SonuÃ§larÄ±" > /tmp/comment_body.md
          echo "" >> /tmp/comment_body.md
          echo "| Problem | Puan | Durum |" >> /tmp/comment_body.md
          echo "|---------|------|-------|" >> /tmp/comment_body.md
          
          # Failed tests file
          echo "" > /tmp/failed_tests.md
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            
            if [[ "$file" =~ problem-([1-4])/submissions/ ]]; then
              problem_num="${BASH_REMATCH[1]}"
              PROBLEM_DIR="homeworks/csharp-fundamentals/problem-${problem_num}"
              filename=$(basename "$file")
              
              # Mark problem as submitted
              eval "SUBMITTED_P${problem_num}=true"
              
              echo ""
              echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
              echo "â•‘  Problem $problem_num - $filename"
              echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              
              # Create temp directory and setup project
              TEMP_DIR=$(mktemp -d)
              cd "$TEMP_DIR"
              
              # Create a new console project
              dotnet new console -n TestProject -o . --force > /dev/null 2>&1
              
              # CRITICAL FIX: Remove auto-generated Program.cs
              # (it contains "Hello, World!" and would be executed instead of tests)
              rm -f Program.cs
              
              # Copy student submission (keeps original name for class reference)
              cp "$GITHUB_WORKSPACE/$file" "./Problem${problem_num}.cs"
              
              # Copy test file AS Program.cs (it has Main method, becomes entry point)
              cp "$GITHUB_WORKSPACE/$PROBLEM_DIR/Problem${problem_num}.Tests.cs" "./Program.cs"
              
              # Run tests
              set +e
              TEST_OUTPUT=$(dotnet run -- "$filename" 2>&1)
              TEST_EXIT_CODE=$?
              set -e
              
              echo "$TEST_OUTPUT"
              
              # Extract score from output (format: "TOPLAM PUAN      â”‚  25.00 / 25.00 puan")
              SCORE=$(echo "$TEST_OUTPUT" | grep -oP 'TOPLAM PUAN\s*â”‚\s*\K[0-9]+\.?[0-9]*' | head -1 || echo "0")
              [ -z "$SCORE" ] && SCORE="0"
              
              if [ "$TEST_EXIT_CODE" -eq 0 ]; then
                STATUS="âœ… GeÃ§ti"
              else
                STATUS="âŒ KaldÄ±"
                ALL_PASSED=false
                
                # Add failed tests to file
                FAILS=$(echo "$TEST_OUTPUT" | grep "âŒ" | head -5 || true)
                if [ -n "$FAILS" ]; then
                  echo "### Problem ${problem_num} - Hatalar" >> /tmp/failed_tests.md
                  echo '```' >> /tmp/failed_tests.md
                  echo "$FAILS" >> /tmp/failed_tests.md
                  echo '```' >> /tmp/failed_tests.md
                  echo "" >> /tmp/failed_tests.md
                fi
              fi
              
              echo "| Problem ${problem_num} | ${SCORE}/25 | ${STATUS} |" >> /tmp/comment_body.md
              
              TOTAL_SCORE=$(echo "$TOTAL_SCORE + $SCORE" | bc)
              
              cd - > /dev/null
              rm -rf "$TEMP_DIR"
            fi
          done <<< "${{ steps.validate-files.outputs.valid_files }}"
          
          # Add missing problems to table
          MISSING_PROBLEMS=""
          if [ "$SUBMITTED_P1" = false ]; then
            echo "| Problem 1 | 0/25 | âš ï¸ Eksik |" >> /tmp/comment_body.md
            MISSING_PROBLEMS="${MISSING_PROBLEMS}Problem1, "
            ALL_PASSED=false
          fi
          if [ "$SUBMITTED_P2" = false ]; then
            echo "| Problem 2 | 0/25 | âš ï¸ Eksik |" >> /tmp/comment_body.md
            MISSING_PROBLEMS="${MISSING_PROBLEMS}Problem2, "
            ALL_PASSED=false
          fi
          if [ "$SUBMITTED_P3" = false ]; then
            echo "| Problem 3 | 0/25 | âš ï¸ Eksik |" >> /tmp/comment_body.md
            MISSING_PROBLEMS="${MISSING_PROBLEMS}Problem3, "
            ALL_PASSED=false
          fi
          if [ "$SUBMITTED_P4" = false ]; then
            echo "| Problem 4 | 0/25 | âš ï¸ Eksik |" >> /tmp/comment_body.md
            MISSING_PROBLEMS="${MISSING_PROBLEMS}Problem4, "
            ALL_PASSED=false
          fi
          
          echo "" >> /tmp/comment_body.md
          echo "**Toplam Puan:** $TOTAL_SCORE / 100" >> /tmp/comment_body.md
          echo "" >> /tmp/comment_body.md
          
          # Add warning about missing problems
          if [ -n "$MISSING_PROBLEMS" ]; then
            MISSING_PROBLEMS="${MISSING_PROBLEMS%, }"
            echo "> âš ï¸ **Eksik Dosyalar:** $MISSING_PROBLEMS" >> /tmp/comment_body.md
            echo "> LÃ¼tfen eksik problemleri \`submissions/\` klasÃ¶rÃ¼ne ekleyin." >> /tmp/comment_body.md
            echo "" >> /tmp/comment_body.md
          fi
          
          if [ "$ALL_PASSED" = true ]; then
            echo "---" >> /tmp/comment_body.md
            echo "ğŸ‰ **Tebrikler!** TÃ¼m testler geÃ§ti. PR merge edilebilir." >> /tmp/comment_body.md
          else
            # Add failed tests details
            if [ -s /tmp/failed_tests.md ]; then
              echo "---" >> /tmp/comment_body.md
              cat /tmp/failed_tests.md >> /tmp/comment_body.md
            fi
            echo "---" >> /tmp/comment_body.md
            echo "âŒ **PR merge edilemez.** TÃ¼m testlerin geÃ§mesi gerekiyor." >> /tmp/comment_body.md
          fi
          
          echo "" >> /tmp/comment_body.md
          echo "---" >> /tmp/comment_body.md
          echo "*GitHub Workshop Bot* ğŸ¤–" >> /tmp/comment_body.md
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š TOPLAM SONUÃ‡: $TOTAL_SCORE / 100 puan"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
          echo "all_passed=$ALL_PASSED" >> $GITHUB_OUTPUT


      - name: Generate Job Summary
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ğŸ“Š C# Ã–dev Test SonuÃ§larÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate-files.outputs.valid }}" = "false" ]; then
            echo "### âŒ Dosya AdÄ± HatasÄ±" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "YanlÄ±ÅŸ format: ${{ steps.validate-files.outputs.invalid_files }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Beklenen format:** ProblemX_OGRENCI_NO.cs (Ã¶ÄŸrenci numarasÄ±, hane sayÄ±sÄ± sÄ±nÄ±rlamasÄ± yok)" >> $GITHUB_STEP_SUMMARY
          elif [ -f /tmp/comment_body.md ]; then
            cat /tmp/comment_body.md >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“š [GitHub Workshop Wiki](https://github.com/Furk4nBulut/Github-Workshop/wiki)" >> $GITHUB_STEP_SUMMARY

      - name: Post PR Comment - Success
        if: always() && steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'true' && steps.run-tests.outputs.all_passed == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('/tmp/comment_body.md', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Post PR Comment - File Name Error
        if: always() && steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const invalidFiles = process.env.INVALID_FILES;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ Dosya AdÄ± HatasÄ±

              YanlÄ±ÅŸ formatta dosyalar: **${invalidFiles}**

              ### ğŸ“‹ DoÄŸru Format
              \`ProblemX_OGRENCI_NO.cs\` (Ã¶ÄŸrenci numarasÄ± â€” hane sayÄ±sÄ± sÄ±nÄ±rlamasÄ± yok)

              **Ã–rnek:** \`Problem1_210316011.cs\`

              ---
              âŒ **PR merge edilemez.** LÃ¼tfen dosya adÄ±nÄ± dÃ¼zeltin.

              ---
              *GitHub Workshop Bot* ğŸ¤–`
            });
        env:
          INVALID_FILES: ${{ steps.validate-files.outputs.invalid_files }}

      - name: Post PR Comment - Test Failed
        if: always() && steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'true' && steps.run-tests.outputs.all_passed == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const commentBody = fs.readFileSync('/tmp/comment_body.md', 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Final Status Check
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          if [ "${{ steps.validate-files.outputs.valid }}" = "false" ]; then
            echo "âŒ Dosya adÄ± formatÄ± yanlÄ±ÅŸ!"
            exit 1
          fi
          
          if [ "${{ steps.run-tests.outputs.all_passed }}" = "false" ]; then
            echo "âŒ BazÄ± testler baÅŸarÄ±sÄ±z!"
            exit 1
          fi
          
          echo "âœ… TÃ¼m kontroller baÅŸarÄ±lÄ±!"
