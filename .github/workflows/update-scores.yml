name: Update Scores

# Bu workflow test sonuÃ§larÄ±nÄ± scores.json'a kaydeder
on:
  workflow_run:
    workflows: ["C# Homework Tests"]
    types: [completed]

permissions:
  contents: write

jobs:
  update-scores:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event.workflow_run.conclusion == 'failure'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download Test Artifacts
        uses: actions/github-script@v7
        id: get-scores
        with:
          script: |
            // Get the workflow run that triggered this
            const runId = context.payload.workflow_run.id;
            
            // Get jobs from the workflow run
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });
            
            // Find the test job
            const testJob = jobs.data.jobs.find(j => j.name === 'Validate & Test C# Submissions');
            
            if (!testJob) {
              console.log('Test job not found');
              return { found: false };
            }
            
            // Get the logs to extract scores
            try {
              const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                job_id: testJob.id
              });
              
              // Parse logs to find scores
              const logContent = logs.data;
              
              // Extract student number and scores from logs
              const studentMatch = logContent.match(/Problem[1-4]_(\d+)\.cs/);
              const scoreMatch = logContent.match(/TOPLAM SONUÃ‡:\s*(\d+(?:\.\d+)?)\s*\/\s*100/);
              
              const p1Match = logContent.match(/Problem 1\s+(\d+(?:\.\d+)?)\/25/);
              const p2Match = logContent.match(/Problem 2\s+(\d+(?:\.\d+)?)\/25/);
              const p3Match = logContent.match(/Problem 3\s+(\d+(?:\.\d+)?)\/25/);
              const p4Match = logContent.match(/Problem 4\s+(\d+(?:\.\d+)?)\/25/);

              if (studentMatch && scoreMatch) {
                return {
                  found: true,
                  studentNo: studentMatch[1],
                  totalScore: parseFloat(scoreMatch[1]),
                  p1: p1Match ? parseFloat(p1Match[1]) : 0,
                  p2: p2Match ? parseFloat(p2Match[1]) : 0,
                  p3: p3Match ? parseFloat(p3Match[1]) : 0,
                  p4: p4Match ? parseFloat(p4Match[1]) : 0
                };
              }
            } catch (e) {
              console.log('Could not parse logs:', e.message);
            }
            
            return { found: false };

      - name: Update Scores JSON
        if: steps.get-scores.outputs.result != '{"found":false}'
        run: |
          # Parse the result
          RESULT='${{ steps.get-scores.outputs.result }}'
          
          if [ "$RESULT" = '{"found":false}' ]; then
            echo "No scores to update"
            exit 0
          fi
          
          # Extract values using jq
          STUDENT_NO=$(echo "$RESULT" | jq -r '.studentNo // empty')
          TOTAL_SCORE=$(echo "$RESULT" | jq -r '.totalScore // 0')
          P1_SCORE=$(echo "$RESULT" | jq -r '.p1 // 0')
          P2_SCORE=$(echo "$RESULT" | jq -r '.p2 // 0')
          P3_SCORE=$(echo "$RESULT" | jq -r '.p3 // 0')
          P4_SCORE=$(echo "$RESULT" | jq -r '.p4 // 0')
          
          if [ -z "$STUDENT_NO" ]; then
            echo "No student number found"
            exit 0
          fi
          
          echo "Updating scores for student: $STUDENT_NO"
          echo "Total: $TOTAL_SCORE (P1: $P1_SCORE, P2: $P2_SCORE, P3: $P3_SCORE, P4: $P4_SCORE)"
          
          # Update scores.json
          SCORES_FILE="docs/data/scores.json"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Read current scores
          if [ -f "$SCORES_FILE" ]; then
            CURRENT=$(cat "$SCORES_FILE")
          else
            CURRENT='{"lastUpdated":"","statistics":{"totalStudents":0,"totalSubmissions":0,"averageScore":0,"highestScore":0,"problemStats":{"problem1":{"attempts":0,"avgScore":0,"passRate":0},"problem2":{"attempts":0,"avgScore":0,"passRate":0},"problem3":{"attempts":0,"avgScore":0,"passRate":0},"problem4":{"attempts":0,"avgScore":0,"passRate":0}}},"students":[]}'
          fi
          
          # Check if student already exists
          EXISTING=$(echo "$CURRENT" | jq --arg sno "$STUDENT_NO" '.students[] | select(.studentNo == $sno)')
          
          if [ -n "$EXISTING" ]; then
            # Update existing student
            UPDATED=$(echo "$CURRENT" | jq --arg sno "$STUDENT_NO" --arg score "$TOTAL_SCORE" --arg p1 "$P1_SCORE" --arg p2 "$P2_SCORE" --arg p3 "$P3_SCORE" --arg p4 "$P4_SCORE" --arg ts "$TIMESTAMP" '
              .lastUpdated = $ts |
              .students = [.students[] | if .studentNo == $sno then 
                .total = ($score | tonumber) | 
                .scores.problem1 = ($p1 | tonumber) |
                .scores.problem2 = ($p2 | tonumber) |
                .scores.problem3 = ($p3 | tonumber) |
                .scores.problem4 = ($p4 | tonumber) |
                .lastSubmission = $ts 
              else . end]
            ')
          else
            # Add new student
            NEW_STUDENT="{\"studentNo\":\"$STUDENT_NO\",\"scores\":{\"problem1\":$P1_SCORE,\"problem2\":$P2_SCORE,\"problem3\":$P3_SCORE,\"problem4\":$P4_SCORE},\"total\":$TOTAL_SCORE,\"lastSubmission\":\"$TIMESTAMP\"}"

            UPDATED=$(echo "$CURRENT" | jq --argjson student "$NEW_STUDENT" --arg ts "$TIMESTAMP" '
              .lastUpdated = $ts |
              .students += [$student] |
              .statistics.totalStudents = (.students | length)
            ')
          fi
          
          # Recalculate statistics
          FINAL=$(echo "$UPDATED" | jq '
            .statistics.totalStudents = (.students | length) |
            .statistics.totalSubmissions = ([.students[].total | select(. > 0)] | length) |
            .statistics.averageScore = (if (.students | length) > 0 then ([.students[].total] | add / length) else 0 end) |
            .statistics.highestScore = ([.students[].total] | max // 0)
          ')
          
          # Write back
          echo "$FINAL" | jq '.' > "$SCORES_FILE"
          
          echo "Scores updated successfully"
          cat "$SCORES_FILE"

      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/data/scores.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update student scores [skip ci]"
            git push
          fi
